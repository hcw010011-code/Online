<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ í‹±íƒí†  ëŒ€ê²°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ì‚¬ìš©ìê°€ ì œê³µí•œ Firebase ì„¤ì •ê°’ ì ìš© ì™„ë£Œ
        const firebaseConfig = {
            apiKey: "AIzaSyAWtdYncScCZgMJiy1SZRq1eOylmby5syI",
            authDomain: "tictactoe-a7f97.firebaseapp.com",
            projectId: "tictactoe-a7f97",
            storageBucket: "tictactoe-a7f97.firebasestorage.app",
            messagingSenderId: "113959866370",
            appId: "1:113959866370:web:7e45128e24e2b3834ed71b",
            measurementId: "G-P1MXHFQZYT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let roomId = "";
        let myMark = ""; 
        let currentBoard = Array(9).fill("");
        let currentTurn = "X";
        let unsub = null;

        // ìµëª… ì¸ì¦ ì‹¤í–‰ (Firestore ì ‘ê·¼ ê¶Œí•œ íšë“)
        signInAnonymously(auth).catch(err => console.error("Firebase ì¸ì¦ ì‹¤íŒ¨:", err));

        // ë¬´ì‘ìœ„ ë°© ë²ˆí˜¸ ìƒì„±
        window.createRandomRoom = () => {
            const randomId = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('roomInput').value = randomId;
            window.joinRoom();
        };

        // ë°© ì…ì¥ ì²˜ë¦¬
        window.joinRoom = async () => {
            const inputId = document.getElementById('roomInput').value.trim();
            if (!inputId) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

            roomId = inputId;
            const roomRef = doc(db, "rooms", roomId);
            
            try {
                const roomSnap = await getDoc(roomRef);

                if (!roomSnap.exists()) {
                    // ë‚´ê°€ ì²˜ìŒ ë§Œë“œëŠ” ì‚¬ëŒ (X)
                    myMark = "X";
                    await setDoc(roomRef, {
                        board: Array(9).fill(""),
                        turn: "X",
                        winner: ""
                    });
                } else {
                    // ì´ë¯¸ ìˆëŠ” ë°©ì— ì…ì¥ (O)
                    if (!myMark) myMark = "O";
                }

                // ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘
                if (unsub) unsub();
                unsub = onSnapshot(roomRef, (snap) => {
                    if (!snap.exists()) return;
                    const data = snap.data();
                    
                    // ë³´ë“œ íŒ ê·¸ë¦¬ê¸°
                    renderBoard(data.board);
                    currentBoard = data.board;
                    currentTurn = data.turn;
                    updateStatus(data);
                });

                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('game-area').classList.remove('hidden');
            } catch (error) {
                console.error("ì…ì¥ ì¤‘ ì—ëŸ¬:", error);
                alert("ì—°ê²° ì‹¤íŒ¨! Firebase ì½˜ì†”ì—ì„œ Firestore ê·œì¹™ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }
        };

        function renderBoard(board) {
            board.forEach((val, i) => {
                const cell = document.getElementById(`cell-${i}`);
                if (val && cell.innerHTML === "") {
                    cell.innerHTML = val === 'X' ? getXSVG() : getOSVG();
                } else if (!val) {
                    cell.innerHTML = "";
                }
            });
        }

        function updateStatus(data) {
            const status = document.getElementById('status');
            const info = document.getElementById('info');
            info.innerText = `ë°© ID: ${roomId} | ë‚˜ì˜ ê¸°í˜¸: ${myMark}`;

            if (data.winner) {
                status.innerText = data.winner === 'Draw' ? "ë¬´ìŠ¹ë¶€!" : `${data.winner} ìŠ¹ë¦¬! ğŸ‰`;
                status.className = "text-3xl font-bold text-yellow-400 animate-bounce mb-6";
            } else {
                const isMyTurn = (data.turn === myMark);
                status.innerText = isMyTurn ? "ğŸ”¥ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : "âŒ› ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...";
                status.className = `text-xl mb-6 font-bold ${isMyTurn ? 'text-blue-400' : 'text-gray-400'}`;
            }
        }

        window.makeMove = async (i) => {
            if (currentBoard[i] !== "" || currentTurn !== myMark || checkWinner(currentBoard)) return;

            const newBoard = [...currentBoard];
            newBoard[i] = myMark;
            const winner = checkWinner(newBoard);
            const nextTurn = myMark === "X" ? "O" : "X";

            await updateDoc(doc(db, "rooms", roomId), {
                board: newBoard,
                turn: nextTurn,
                winner: winner || ""
            });
        };

        function checkWinner(b) {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b_idx,c] of lines) {
                if (b[a] && b[a] === b[b_idx] && b[a] === b[c]) return b[a];
            }
            return !b.includes("") ? "Draw" : null;
        }

        window.resetGame = async () => {
            await updateDoc(doc(db, "rooms", roomId), {
                board: Array(9).fill(""),
                turn: "X",
                winner: ""
            });
        };

        // SVG ë“œë¡œì‰ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
        function getXSVG() {
            return `<svg class="w-16 h-16" viewBox="0 0 100 100"><path d="M25 25 L75 75" stroke="#60a5fa" stroke-width="10" stroke-linecap="round" fill="none" class="draw-path"/><path d="M75 25 L25 75" stroke="#60a5fa" stroke-width="10" stroke-linecap="round" fill="none" class="draw-path" style="animation-delay: 0.2s;"/></svg>`;
        }
        function getOSVG() {
            return `<svg class="w-16 h-16" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#f87171" stroke-width="10" stroke-linecap="round" fill="none" class="draw-circle"/></svg>`;
        }
    </script>
    <style>
        @keyframes draw { to { stroke-dashoffset: 0; } }
        .draw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw 0.3s forwards; }
        .draw-circle { stroke-dasharray: 200; stroke-dashoffset: 200; animation: draw 0.5s forwards; }
        body { background: radial-gradient(circle at center, #1e293b, #0f172a); color: white; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- ë¡œë¹„ -->
    <div id="lobby" class="bg-gray-900/80 backdrop-blur-md p-10 rounded-3xl border border-white/10 shadow-2xl text-center w-80">
        <h1 class="text-4xl font-black mb-6 tracking-tighter">TIC TAC TOE</h1>
        <input id="roomInput" type="text" placeholder="ë°© ë²ˆí˜¸ ì…ë ¥" 
            class="w-full bg-black border border-gray-700 rounded-xl px-4 py-4 mb-4 text-center text-2xl font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
        <button onclick="joinRoom()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold shadow-lg transition active:scale-95 mb-3">ë°© ì…ì¥í•˜ê¸°</button>
        <button onclick="createRandomRoom()" class="w-full bg-white/5 hover:bg-white/10 py-3 rounded-xl text-sm transition text-gray-400 border border-white/5">ëœë¤ ë°© ë§Œë“¤ê¸°</button>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="game-area" class="hidden text-center px-4 w-full max-w-sm">
        <div id="info" class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-mono"></div>
        <div id="status" class="mb-6"></div>
        
        <div class="grid grid-cols-3 gap-4 bg-white/5 p-4 rounded-3xl border border-white/10 shadow-2xl">
            <div id="cell-0" onclick="makeMove(0)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-1" onclick="makeMove(1)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-2" onclick="makeMove(2)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-3" onclick="makeMove(3)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-4" onclick="makeMove(4)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-5" onclick="makeMove(5)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-6" onclick="makeMove(6)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-7" onclick="makeMove(7)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
            <div id="cell-8" onclick="makeMove(8)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24 shadow-inner"></div>
        </div>

        <div class="mt-10 flex justify-center gap-6">
            <button onclick="resetGame()" class="text-gray-500 hover:text-white text-xs underline decoration-gray-700 underline-offset-4">ê²Œì„ ë¦¬ì…‹</button>
            <button onclick="location.reload()" class="text-gray-500 hover:text-white text-xs underline decoration-gray-700 underline-offset-4">ë°© ë‚˜ê°€ê¸°</button>
        </div>
    </div>

</body>
</html>

