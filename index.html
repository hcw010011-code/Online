<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // [ì¤‘ìš”] ìŠ¤í¬ë¦°ìƒ·ì— ìˆë˜ ë³¸ì¸ì˜ ì„¤ì •ê°’ì„ ì—¬ê¸°ì— ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”!
        const firebaseConfig = {
            apiKey: "ë³¸ì¸ì˜_API_KEY",
            authDomain: "tictactoe-a7f97.firebaseapp.com",
            projectId: "tictactoe-a7f97",
            storageBucket: "tictactoe-a7f97.appspot.com",
            messagingSenderId: "113959866370",
            appId: "ë³¸ì¸ì˜_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let roomId = "";
        let myMark = ""; 
        let currentBoard = Array(9).fill("");
        let currentTurn = "X";
        let unsub = null;

        // ìµëª… ë¡œê·¸ì¸ ì‹¤í–‰ (Firestore ì ‘ê·¼ ê¶Œí•œ í™•ë³´)
        signInAnonymously(auth).catch(err => console.error("ì¸ì¦ ì˜¤ë¥˜:", err));

        window.createRandomRoom = () => {
            const randomId = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('roomInput').value = randomId;
            window.joinRoom();
        };

        window.joinRoom = async () => {
            const inputId = document.getElementById('roomInput').value.trim();
            if (!inputId) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

            roomId = inputId;
            const roomRef = doc(db, "rooms", roomId);
            
            // ë°© ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                // ë‚´ê°€ ë°©ì¥ (X)
                myMark = "X";
                await setDoc(roomRef, {
                    board: Array(9).fill(""),
                    turn: "X",
                    winner: "",
                    playerCount: 1
                });
            } else {
                // ì´ë¯¸ ë°©ì´ ìˆìŒ (ë‚˜ëŠ” O)
                if (!myMark) {
                    myMark = "O";
                    await updateDoc(roomRef, { playerCount: 2 });
                }
            }

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            if (unsub) unsub();
            unsub = onSnapshot(roomRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                // ë³´ë“œ ë°ì´í„°ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ ë Œë”ë§ (SVG ì¤‘ë³µ ìƒì„± ë°©ì§€)
                if (JSON.stringify(currentBoard) !== JSON.stringify(data.board)) {
                    renderBoard(data.board);
                }
                currentBoard = data.board;
                currentTurn = data.turn;
                updateStatus(data);
            }, (error) => {
                console.error("ì—°ê²° ì˜¤ë¥˜:", error);
                alert("ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firestore Rulesë¥¼ í™•ì¸í•˜ì„¸ìš”!");
            });

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
        };

        function renderBoard(board) {
            board.forEach((val, i) => {
                const cell = document.getElementById(`cell-${i}`);
                if (val && cell.innerHTML === "") {
                    cell.innerHTML = val === 'X' ? getXSVG() : getOSVG();
                } else if (!val) {
                    cell.innerHTML = "";
                }
            });
        }

        function updateStatus(data) {
            const status = document.getElementById('status');
            const info = document.getElementById('info');
            info.innerText = `ë°©: ${roomId} | ë‚´ ê¸°í˜¸: ${myMark}`;

            if (data.winner) {
                status.innerText = data.winner === 'Draw' ? "ë¬´ìŠ¹ë¶€!" : `${data.winner} ìŠ¹ë¦¬! ğŸ‰`;
                status.className = "text-3xl font-bold text-yellow-400 animate-bounce mb-6";
            } else {
                const isMyTurn = (data.turn === myMark);
                status.innerText = isMyTurn ? "ğŸ”¥ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : "âŒ› ìƒëŒ€ë°© ì°¨ë¡€...";
                status.className = `text-xl mb-6 font-bold ${isMyTurn ? 'text-blue-400' : 'text-gray-400'}`;
            }
        }

        window.makeMove = async (i) => {
            if (currentBoard[i] !== "" || currentTurn !== myMark || checkWinner(currentBoard)) return;

            const newBoard = [...currentBoard];
            newBoard[i] = myMark;
            const winner = checkWinner(newBoard);
            const nextTurn = myMark === "X" ? "O" : "X";

            await updateDoc(doc(db, "rooms", roomId), {
                board: newBoard,
                turn: nextTurn,
                winner: winner || ""
            });
        };

        function checkWinner(b) {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let [a,b_idx,c] of lines) {
                if (b[a] && b[a] === b[b_idx] && b[a] === b[c]) return b[a];
            }
            return !b.includes("") ? "Draw" : null;
        }

        window.resetGame = async () => {
            await updateDoc(doc(db, "rooms", roomId), {
                board: Array(9).fill(""),
                turn: "X",
                winner: ""
            });
        };

        function getXSVG() {
            return `<svg class="w-16 h-16" viewBox="0 0 100 100"><path d="M25 25 L75 75" stroke="#60a5fa" stroke-width="10" stroke-linecap="round" fill="none" class="draw-path"/><path d="M75 25 L25 75" stroke="#60a5fa" stroke-width="10" stroke-linecap="round" fill="none" class="draw-path" style="animation-delay: 0.2s;"/></svg>`;
        }
        function getOSVG() {
            return `<svg class="w-16 h-16" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#f87171" stroke-width="10" stroke-linecap="round" fill="none" class="draw-circle"/></svg>`;
        }
    </script>
    <style>
        @keyframes draw { to { stroke-dashoffset: 0; } }
        .draw-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: draw 0.3s forwards; }
        .draw-circle { stroke-dasharray: 200; stroke-dashoffset: 200; animation: draw 0.5s forwards; }
        body { background: #0f172a; color: white; font-family: sans-serif; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="lobby" class="bg-gray-900 p-10 rounded-3xl border border-white/10 shadow-2xl text-center w-80">
        <h1 class="text-3xl font-black mb-6">TIC TAC TOE</h1>
        <input id="roomInput" type="text" placeholder="ë°© ë²ˆí˜¸" class="w-full bg-black border border-gray-700 rounded-xl px-4 py-3 mb-4 text-center text-xl font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
        <button onclick="joinRoom()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition mb-2">ì…ì¥í•˜ê¸°</button>
        <button onclick="createRandomRoom()" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded-xl text-sm transition text-gray-400">ëœë¤ ë°© ìƒì„±</button>
    </div>

    <div id="game-area" class="hidden text-center px-4 w-full max-w-sm">
        <div id="info" class="text-[11px] text-gray-500 mb-2 uppercase tracking-widest"></div>
        <div id="status" class="mb-4"></div>
        <div class="grid grid-cols-3 gap-3 bg-white/5 p-3 rounded-3xl border border-white/10 shadow-xl">
            <div id="cell-0" onclick="makeMove(0)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-1" onclick="makeMove(1)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-2" onclick="makeMove(2)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-3" onclick="makeMove(3)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-4" onclick="makeMove(4)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-5" onclick="makeMove(5)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-6" onclick="makeMove(6)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-7" onclick="makeMove(7)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
            <div id="cell-8" onclick="makeMove(8)" class="cell aspect-square flex items-center justify-center bg-gray-900 rounded-2xl cursor-pointer hover:bg-gray-800 h-24"></div>
        </div>
        <div class="mt-8 flex justify-center gap-4">
            <button onclick="resetGame()" class="text-gray-500 hover:text-white text-sm underline">ê²Œì„ ë¦¬ì…‹</button>
            <button onclick="location.reload()" class="text-gray-500 hover:text-white text-sm underline">ë°© ë‚˜ê°€ê¸°</button>
        </div>
    </div>

</body>
</html>

